name: Create Release

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²ï¼Œç”¨äºç”Ÿæˆchangelog
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v4
          
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd frontend && pnpm install --frozen-lockfile
          
      - name: Build project
        run: |
          pnpm prisma:generate
          pnpm build
          pnpm frontend:build
          
      - name: Create distribution archive
        run: |
          # åˆ›å»ºå‘å¸ƒåŒ…
          mkdir -p release
          
          # å¤åˆ¶æ„å»ºäº§ç‰©å’Œå¿…è¦æ–‡ä»¶
          cp -r dist release/
          cp -r frontend/dist release/frontend
          cp -r prisma release/
          cp -r config release/
          cp package.json pnpm-lock.yaml release/
          cp README.md LICENSE release/ 2>/dev/null || true
          cp docker-compose.yml Dockerfile start.sh release/ 2>/dev/null || true
          cp -r docker release/ 2>/dev/null || true
          cp .env.example release/.env 2>/dev/null || true

          # åˆå§‹åŒ–æ•°æ®åº“
          pnpm prisma migrate deploy --schema=prisma/schema.prisma
          cp prisma/dev.db release/prisma/dev.db 2>/dev/null || true

          # åˆ›å»ºå‹ç¼©åŒ…
          cd release
          tar -czf ../auto-media-hardlinker-${{ github.ref_name }}.tar.gz .
          cd ..
          
      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªtag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${{ github.ref_name }}$" | head -n1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "changelog=ğŸ‰ Initial release" >> $GITHUB_OUTPUT
          else
            # ç”Ÿæˆå˜æ›´æ—¥å¿—
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "### Changes since $PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..${{ github.ref_name }} >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Release
        run: |
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          PRERELEASE=""
          if [[ "${{ github.ref_name }}" == *"rc"* ]] || [[ "${{ github.ref_name }}" == *"beta"* ]] || [[ "${{ github.ref_name }}" == *"alpha"* ]]; then
            PRERELEASE="--prerelease"
          fi
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜
          cat > release_notes.md << 'EOF'
          ${{ steps.changelog.outputs.changelog }}
          
          ## ğŸ“¦ Installation
          
          ### Option 1: Download Release Archive
          1. Download `auto-media-hardlinker-${{ github.ref_name }}.tar.gz` from the assets below
          2. Extract the archive
          3. Follow the README instructions
          
          ### Option 2: Use Docker Image
          ```bash
          # Pull the Docker image
          docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          
          # Run with docker-compose
          curl -O https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/docker-compose.yml
          docker-compose up -d
          
          # Or run directly
          docker run -d -p 80:80 ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          ```
          
          ## ğŸ”— Links
          - **Docker Image**: [ghcr.io/${{ github.repository }}:${{ github.ref_name }}](https://ghcr.io/${{ github.repository }})
          - **Source Code**: [View on GitHub](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }})
          
          EOF
          
          # ä½¿ç”¨ GitHub CLI åˆ›å»º release
          gh release create "${{ github.ref_name }}" \
            --title "Release ${{ github.ref_name }}" \
            --notes-file release_notes.md \
            $PRERELEASE \
            auto-media-hardlinker-${{ github.ref_name }}.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Output release details
        run: |
          echo "### ğŸš€ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Assets:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`auto-media-hardlinker-${{ github.ref_name }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
